# Dockerfile baseado no oficial do OHF-Voice/piper1-gpl
# ReferÃªncia: https://github.com/OHF-Voice/piper1-gpl/blob/main/Dockerfile
FROM python:3.12 AS builder

# Instalar dependÃªncias de build (CMake, Ninja, Git)
RUN apt-get update && \
    apt-get install --yes --no-install-recommends \
      build-essential \
      cmake \
      ninja-build \
      git && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Clonar repositÃ³rio e fazer build completo usando scripts oficiais
RUN git clone --depth 1 https://github.com/OHF-Voice/piper1-gpl.git /tmp/piper && \
    cp -r /tmp/piper/* /app/ && \
    rm -rf /tmp/piper && \
    pip3 install --no-cache-dir build scikit-build cmake && \
    python3 script/setup --dev && \
    python3 script/dev_build && \
    python3 script/package

# -----------------------------------------------------------------------------
# Imagem final (otimizada)
# -----------------------------------------------------------------------------
FROM python:3.12-slim

# Metadados
LABEL org.opencontainers.image.title="Piper TTS" \
      org.opencontainers.image.description="Fast local neural TTS (OHF-Voice fork)" \
      org.opencontainers.image.version="1.3.0+" \
      org.opencontainers.image.licenses="GPL-3.0" \
      org.opencontainers.image.source="https://github.com/OHF-Voice/piper1-gpl"

ENV PIP_BREAK_SYSTEM_PACKAGES=1

# Instalar runtime dependencies
RUN apt-get update && \
    apt-get install --yes --no-install-recommends \
      curl \
      ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Criar usuÃ¡rio nÃ£o-root
RUN useradd -m -u 1000 -s /bin/bash piper

WORKDIR /app

# Copiar wheel compilado do builder
COPY --from=builder /app/dist/piper_tts-*linux*.whl ./dist/

# Instalar Piper + dependÃªncias HTTP
RUN pip3 install ./dist/piper_tts-*linux*.whl && \
    pip3 install 'flask>=3,<4'

# Criar diretÃ³rios
RUN mkdir -p /data /app/output && \
    chown -R piper:piper /data /app

# Script de inicializaÃ§Ã£o
COPY --chown=piper:piper <<'EOF' /entrypoint.sh
#!/usr/bin/env bash
set -e

DATA_DIR='/data'
COMMAND="$1"
shift || true

# Deriva vozes a partir de /app/config/voices.json se disponÃ­vel (v2 com available_voices e backends opcionais)
CFG_JSON="/app/config/voices.json"
DEFAULT_MODEL=""
ALL_MODELS=""
if [ -f "$CFG_JSON" ]; then
  # Extrai modelo default e lista de modelos do voices.json
  readarray -t LINES < <(python3 - <<'PY'
import json
from pathlib import Path
p = Path('/app/config/voices.json')
try:
  d = json.loads(p.read_text(encoding='utf-8'))
  voices = d.get('available_voices', {})
  dv = d.get('default_voice')
  if not dv or dv not in voices:
    dv = next(iter(voices.keys()), None)
  default_model = voices.get(dv, {}).get('model_id') if dv else ''
  models = []
  for v in voices.values():
    mid = v.get('model_id')
    if isinstance(mid, str) and mid not in models:
      models.append(mid)
  print(default_model)
  print(','.join(models))
except Exception:
  print('')
  print('')
PY
)
  DEFAULT_MODEL="${LINES[0]}"
  ALL_MODELS="${LINES[1]}"
fi

# PrÃ©-download de vozes
preload_voice() {
  local v="$1"
  v="${v// /}" # remove espaÃ§os
  if [ -z "$v" ]; then return; fi
  if [ ! -f "${DATA_DIR}/${v}.onnx" ]; then
    echo "ðŸ“¥ Baixando voz ${v}..."
    python3 -m piper.download_voices "$v" --data-dir "${DATA_DIR}" || echo "âš ï¸ Falha ao baixar ${v}"
  fi
}

# Baixar voz principal (se definido)
if [ -n "$DEFAULT_MODEL" ]; then
  preload_voice "$DEFAULT_MODEL"
fi

# Baixar vozes adicionais, se configuradas
if [ -n "$ALL_MODELS" ]; then
  IFS=',' read -r -a _VOICES <<< "$ALL_MODELS"
  for vv in "${_VOICES[@]}"; do
    preload_voice "$vv"
  done
fi

case "${COMMAND}" in
  speak)
    exec python3 -m piper --data-dir "${DATA_DIR}" "$@"
    ;;
  download)
    exec python3 -m piper.download_voices --data-dir "${DATA_DIR}" "$@"
    ;;
  server)
    echo "ðŸš€ Iniciando Piper TTS HTTP Server v1.3.1 (GPL)"
    # Se -m nÃ£o foi informado explicitamente e temos DEFAULT_MODEL, injeta
    ARGS=("--data-dir" "${DATA_DIR}")
    HAVE_MODEL_ARG=0
    for a in "$@"; do
      if [ "$a" = "-m" ] || [[ "$a" == "--model"* ]]; then HAVE_MODEL_ARG=1; fi
      ARGS+=("$a")
    done
    if [ $HAVE_MODEL_ARG -eq 0 ] && [ -n "$DEFAULT_MODEL" ]; then
      ARGS=("-m" "$DEFAULT_MODEL" "${ARGS[@]}")
    fi
    exec python3 -m piper.http_server "${ARGS[@]}"
    ;;
  ""|help|-h|--help)
    echo "Usage: <command> [args...]"
    echo "Available commands:"
    echo "  speak        Synthesize audio from text"
    echo "  download     Download voices"
    echo "  server       Run HTTP server (default)"
    exit 0
    ;;
  *)
    echo "Error: Unknown command '$COMMAND'"
    echo "Run with --help for usage."
    exit 1
    ;;
esac
EOF

RUN chmod +x /entrypoint.sh

USER piper
EXPOSE 5000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["server", "--host", "0.0.0.0", "--port", "5000"]
