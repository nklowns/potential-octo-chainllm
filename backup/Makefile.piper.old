# Makefile para gerenciar Piper TTS v1.3.1 (GPL)
# MigraÃ§Ã£o de rhasspy/piper (MIT, arquivado) â†’ OHF-Voice/piper1-gpl (GPL)

include .env

.PHONY: help build up down logs test clean migrate

# VariÃ¡veis
COMPOSE_FILE := docker-compose.tts.yml
SERVICE_NAME := piper-tts
VOICE := pt_BR-faber-medium

help: ## Mostra esta mensagem de ajuda
	@echo "ðŸŽ™ï¸  Piper TTS v1.3.1 (GPL) - Comandos DisponÃ­veis"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

build: ## Build da imagem Docker com Piper v1.3.1
	@echo "ðŸ”¨ Building Piper TTS v1.3.1 (GPL)..."
	docker-compose -f $(COMPOSE_FILE) build $(SERVICE_NAME)

up: ## Inicia o serviÃ§o Piper TTS
	@echo "ðŸš€ Starting Piper TTS..."
	docker-compose -f $(COMPOSE_FILE) up -d $(SERVICE_NAME)
	@echo "âœ… Piper TTS iniciado! Aguarde download da voz (primeira vez)..."
	@echo "ðŸ’¡ Logs: make logs"

down: ## Para o serviÃ§o Piper TTS
	@echo "ðŸ›‘ Stopping Piper TTS..."
	docker-compose -f $(COMPOSE_FILE) down

logs: ## Mostra logs do Piper TTS
	docker-compose -f $(COMPOSE_FILE) logs -f $(SERVICE_NAME)

status: ## Verifica status do serviÃ§o
	@echo "ðŸ“Š Status do Piper TTS:"
	@docker-compose -f $(COMPOSE_FILE) ps $(SERVICE_NAME)
	@echo ""
	@echo "ðŸ” Health check:"
	@docker inspect --format='{{.State.Health.Status}}' $(SERVICE_NAME) 2>/dev/null || echo "Container nÃ£o encontrado"

test: ## Testa API do Piper TTS via Traefik
	@echo "ðŸ§ª Testando Piper TTS API via Traefik..."
	@echo ""
	@echo "1ï¸âƒ£  Testando endpoint /voices:"
	@curl -s https://$(TTS_SERVICE_NAME).$(DOMAIN_DUCKDNS)/voices | jq . || echo "âŒ Falha ao listar vozes"
	@echo ""
	@echo "2ï¸âƒ£  Testando sÃ­ntese de Ã¡udio:"
	@mkdir -p output/audio
	@curl -X POST https://$(TTS_SERVICE_NAME).$(DOMAIN_DUCKDNS) \
		-H 'Content-Type: application/json' \
		-d '{"text": "Teste de migraÃ§Ã£o bem-sucedido! Piper TTS versÃ£o 1.3.0 GPL funcionando via Traefik."}' \
		-o output/audio/teste_migracao.wav && echo "âœ… Ãudio salvo em output/audio/teste_migracao.wav" || echo "âŒ Falha na sÃ­ntese"

voices: ## Lista vozes disponÃ­veis no container
	@echo "ðŸ—£ï¸  Vozes disponÃ­veis:"
	docker exec -it $(SERVICE_NAME) python3 -m piper.download_voices 2>/dev/null || \
		echo "âŒ Container nÃ£o estÃ¡ rodando"

download-voice: ## Download manual de voz (uso: make download-voice VOICE=en_US-lessac-medium)
	@echo "ðŸ“¥ Baixando voz: $(VOICE)"
	docker exec -it $(SERVICE_NAME) \
		python3 -m piper.download_voices $(VOICE) --data-dir /data

shell: ## Abre shell no container
	docker exec -it $(SERVICE_NAME) bash

clean: ## Remove container, imagem e volumes
	@echo "ðŸ§¹ Limpando Piper TTS..."
	docker-compose -f $(COMPOSE_FILE) down -v
	docker rmi piper-tts:1.3.1-gpl 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da"

migrate: ## Aplica migraÃ§Ã£o completa (build + up + test)
	@echo "ðŸ”„ Iniciando migraÃ§Ã£o Piper TTS..."
	@echo ""
	@echo "Passo 1/4: Parando versÃ£o antiga..."
	-@docker-compose -f $(COMPOSE_FILE) down 2>/dev/null || true
	@echo ""
	@echo "Passo 2/4: Building nova versÃ£o (v1.3.0+ GPL)..."
	@$(MAKE) -f Makefile.piper build
	@echo ""
	@echo "Passo 3/4: Iniciando nova versÃ£o..."
	@$(MAKE) -f Makefile.piper up
	@echo ""
	@echo "Passo 4/4: Aguardando container ficar healthy (60s)..."
	@sleep 5
	@echo ""
	@$(MAKE) -f Makefile.piper test
	@echo ""
	@echo "âœ… MigraÃ§Ã£o concluÃ­da!"
	@echo "ðŸ“š DocumentaÃ§Ã£o: MIGRATION_PIPER.md"

rebuild: ## Rebuild forÃ§ado (sem cache)
	@echo "ðŸ”¨ Rebuild completo (sem cache)..."
	docker-compose -f $(COMPOSE_FILE) build --no-cache $(SERVICE_NAME)

restart: ## Restart do serviÃ§o
	@echo "ðŸ”„ Reiniciando Piper TTS..."
	docker-compose -f $(COMPOSE_FILE) restart $(SERVICE_NAME)

# Atalhos
b: build
u: up
d: down
l: logs
t: test
m: migrate
