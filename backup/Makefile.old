# Makefile
include .env

.PHONY: help build tts images manager image-manager pipeline clean monitor test-network migrate-piper

# Configura√ß√µes
INPUT_FILE ?= input/topics.txt

help:
	@echo "üéØ Comandos dispon√≠veis:"
	@echo ""
	@echo "üîß Setup Inicial (IMPORTANTE):"
	@echo "  migrate-piper    - Migra Piper TTS para v1.3.1 (GPL) - EXECUTE PRIMEIRO!"
	@echo "  build            - Constr√≥i a imagem audio-pipeline-app"
	@echo "  test-network     - Testa conectividade na rede"
	@echo ""
	@echo "üöÄ Execu√ß√£o:"
	@echo "  tts              - Inicia servi√ßo TTS com Traefik"
	@echo "  images           - Inicia servi√ßo de Gera√ß√£o de Imagens"
	@echo "  manager          - Executa pipeline de gera√ß√£o de scripts e √°udio"
	@echo "  image-manager    - Executa pipeline de gera√ß√£o de imagens"
	@echo "  pipeline         - Pipeline completo (build + tts + manager)"
	@echo "  full-pipeline    - Pipeline completo incluindo imagens"
	@echo ""
	@echo "üìä Monitoramento:"
	@echo "  monitor          - Monitora resultados"
	@echo "  test-services    - Testa acessibilidade dos servi√ßos"
	@echo ""
	@echo "üßπ Limpeza:"
	@echo "  clean            - Limpa containers e volumes"
	@echo ""
	@echo "üí° Primeiro uso: make migrate-piper && make pipeline"
	@echo "üìö Documenta√ß√£o completa: GUIA_EXECUCAO.md"

migrate-piper:
	@echo "üîÑ Migrando Piper TTS para v1.3.1 (GPL)..."
	@$(MAKE) -f Makefile.piper migrate

build:
	@echo "ÔøΩ Construindo imagem audio-pipeline-app..."
	docker-compose -f docker-compose.manager.yml build

tts:
	@echo "üîä Iniciando servi√ßo TTS com Traefik..."
	docker-compose -f docker-compose.tts.yml up -d

images:
	@echo "üñºÔ∏è Iniciando servi√ßo de Gera√ß√£o de Imagens com Traefik..."
	docker-compose -f docker-compose.images.yml up -d

manager: build
	@echo "üéØ Executando pipeline de gera√ß√£o de scripts e √°udio..."
	INPUT_FILE=$(INPUT_FILE) docker-compose -f docker-compose.manager.yml up manager

image-manager: build
	@echo "üé® Executando pipeline de gera√ß√£o de imagens..."
	docker-compose -f docker-compose.manager.yml run --rm image-generator

pipeline: build tts manager

monitor:
	@echo "üìä Monitorando resultados..."
	@echo "=== SCRIPTS GERADOS ==="
	@ls -la output/scripts/ 2>/dev/null | grep -E "(script_.*\.txt|total)" || echo "Nenhum script encontrado"
	@echo "=== √ÅUDIOS GERADOS ==="
	@ls -la output/audio/ 2>/dev/null | grep -E "(script_.*\.wav|total)" || echo "Nenhum √°udio encontrado"
	@echo "=== IMAGENS GERADAS ==="
	@ls -la output/images/ 2>/dev/null | grep -E "(script_.*\.png|total)" || echo "Nenhuma imagem encontrada"
	@echo "=== CONTAINERS ATIVOS ==="
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(piper-tts|pipeline-manager|stable-diffusion-api)" || echo "Nenhum container ativo"

clean:
	@echo "üßπ Limpando ambiente..."
	docker-compose -f docker-compose.tts.yml down
	docker-compose -f docker-compose.images.yml down
	docker-compose -f docker-compose.manager.yml down
	@echo "‚úÖ Limpeza conclu√≠da"

test-network:
	@echo "üîó Testando conectividade na rede $(TRAEFIK_NETWORK)..."
	@docker network inspect $(TRAEFIK_NETWORK) >/dev/null 2>&1 && echo "‚úÖ Rede $(TRAEFIK_NETWORK) existe" || echo "‚ùå Rede $(TRAEFIK_NETWORK) n√£o encontrada"
	@echo "üåê Testando DNS interno..."
	@docker run --rm --network $(TRAEFIK_NETWORK) alpine nslookup piper-tts >/dev/null 2>&1 && echo "‚úÖ DNS para TTS funcionando" || echo "‚ùå DNS para TTS com problemas"
	@docker run --rm --network $(TRAEFIK_NETWORK) alpine nslookup stable-diffusion-api >/dev/null 2>&1 && echo "‚úÖ DNS para SD funcionando" || echo "‚ùå DNS para SD com problemas"

test-services:
	@echo "üß™ Testando servi√ßos..."
	@echo "Testando TTS..."
	@curl -s http://piper-tts.$(DOMAIN_DUCKDNS) >/dev/null && echo "‚úÖ TTS acess√≠vel via Traefik" || echo "‚ùå TTS n√£o acess√≠vel"
	@echo "Testando Stable Diffusion..."
	@curl -s http://sd-api.$(DOMAIN_DUCKDNS) >/dev/null && echo "‚úÖ Stable Diffusion acess√≠vel via Traefik" || echo "‚ùå Stable Diffusion n√£o acess√≠vel"
	@echo "Testando Ollama..."
	@curl -s $(OLLAMA_BASE_URL)/api/tags >/dev/null && echo "‚úÖ Ollama acess√≠vel" || echo "‚ùå Ollama n√£o acess√≠vel"

dev: clean test-network build pipeline monitor

# Comando para desenvolvimento r√°pido com Ollama local
local-ollama:
	@echo "ü§ñ Iniciando Ollama local..."
	docker-compose -f docker-compose.ollama.yml up -d

full-pipeline: build local-ollama images pipeline image-manager