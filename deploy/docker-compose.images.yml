networks:
  proxy_net:
    external: true
    name: proxy_net

services:
  stable-diffusion-api:
    image: automatic1111/stable-diffusion-webui:latest
    container_name: stable-diffusion-api
    restart: unless-stopped
    command: --xformers --enable-api --nowebui --listen
    env_file:
      - .env
    networks:
      - proxy_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7860/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy_net
      - traefik.http.routers.stable-diffusion.rule=Host(`sd-api.${DOMAIN_DUCKDNS}`) || Host(`sd-api.${DOMAIN_LOCAL}`)
      - traefik.http.routers.stable-diffusion.entrypoints=${TRAEFIK_ENTRYPOINT}
      - traefik.http.routers.stable-diffusion.tls.certresolver=myresolver
      - traefik.http.services.stable-diffusion.loadbalancer.server.port=7860
